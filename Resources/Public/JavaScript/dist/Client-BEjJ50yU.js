import{INIT_STATE as e,MachineStatus as t,createScope as n,mergeProps as r}from"@zag-js/core";import{ListCollection as i}from"@zag-js/collection";import{proxy as a,subscribe as o}from"@zag-js/store";import{compact as s,identity as c,isEqual as l,isFunction as u,isString as d,runIfFn as f,toArray as p,warn as m}from"@zag-js/utils";import{createNormalizer as h}from"@zag-js/types";import{nanoid as g}from"nanoid";var _=class{document;machine;api;hydrator=null;userProps;get doc(){return this.document}constructor(e,t=document){this.document=t,this.userProps=e,this.machine=this.initMachine(e),this.api=this.initApi()}init(){this.hydrator=new b(this.name,this.machine.scope.id,this.machine.scope.ids,this.doc),this.render(),this.machine.subscribe(()=>{this.api=this.initApi(),this.render()}),this.machine.start()}updateProps(e){this.machine.stop(),this.machine=this.initMachine({...this.userProps,...e}),this.api=this.initApi(),this.init()}destroy=()=>{this.machine.stop(),this.hydrator?.destroy()};spreadProps(e,t){k(e,t,this.machine.scope.id)}getElement(e,t){return this.hydrator?.getElement(e,t)||null}getElements(e,t){return this.hydrator?.getElements(e,t)||[]}portalElement(e,t=this.doc.body){e&&e.parentNode!==t&&(t.appendChild(e),e.setAttribute(`data-portalled`,`true`))}};function v(e,t){let n=window.FluidPrimitives.hydrationData;return!n||typeof n!=`object`?null:e?n[e]?t?n[e][t]||null:n[e]:null:n}function y(e,t){let n=v(e);n&&Object.keys(n).forEach(r=>{if(n[r].controlled)return;let i=t(n[r]);i&&(window.FluidPrimitives.uncontrolledInstances[e]||(window.FluidPrimitives.uncontrolledInstances[e]={}),window.FluidPrimitives.uncontrolledInstances[e][r]=i)})}var b=class{componentName;doc;rootId;ids;elementRefs=new Map;constructor(e,t,n={},r=document){if(this.componentName=e,this.doc=r,!t)throw Error(`Root ID is required for component hydration: ${e}`);this.rootId=t,this.ids=n}getElement(e,t=this.doc){if(this.elementRefs.has(e))return this.elementRefs.get(e)||null;let n=null;return n=this.ids[e]?t.querySelector(`#${this.ids[e]}`):t.querySelector(`[data-hydrate-${this.componentName}="${this.rootId}"][data-part="${e}"][data-scope="${this.componentName}"]`),n&&(t===this.doc&&this.elementRefs.set(e,n),n.removeAttribute(`data-hydrate-${this.componentName}`),n.__rootId=this.rootId),n}getElements(e,t=this.doc){if(this.elementRefs.has(e))return this.elementRefs.get(e);let n=[];return n=this.ids[e]?Array.from(t.querySelectorAll(`#${this.ids[e]}`)):Array.from(t.querySelectorAll(`[data-hydrate-${this.componentName}="${this.rootId}"][data-part="${e}"][data-scope="${this.componentName}"]`)),t===this.doc&&this.elementRefs.set(e,n),n.forEach(e=>e.removeAttribute(`data-hydrate-${this.componentName}`)),n}generateRefAttributesString(e){let t=this.ids[e]||`${this.rootId}-${e}`;return`data-scope="${this.componentName}" data-part="${e}" data-hydrate-${this.componentName}="${t}"`}setRefAttributes(e,t){let n=this.generateRefAttributesString(t),r=n.split(` `).map(e=>e.trim());r.forEach(t=>{let[n,r]=t.split(`=`);e.setAttribute(n,r.replace(/"/g,``))})}destroy(){this.elementRefs.clear()}};function x(e){let t=new i({items:e.items,itemToValue:e.itemToValueKey?t=>t?.[e.itemToValueKey]:void 0,itemToString:e.itemToStringKey?t=>t?.[e.itemToStringKey]:void 0,isItemDisabled:e.isItemDisabledKey?t=>t?.[e.isItemDisabledKey]:void 0,groupBy:e.groupByKey?t=>{let n=e.groupByKey;if(n)return n.includes(`.`)?n.split(`.`).reduce((e,t)=>e?e[t]:void 0,t):t?.[n]}:void 0});return t}function S(e){let t=e().value??e().defaultValue;e().debug&&console.log(`[bindable > ${e().debug}] initial`,t);let n=e().isEqual??Object.is,r=a({value:t}),i=()=>e().value!==void 0;return{initial:t,ref:r,get(){return i()?e().value:r.value},set(t){let a=r.value,o=u(t)?t(a):t;e().debug&&console.log(`[bindable > ${e().debug}] setValue`,{next:o,prev:a}),i()||(r.value=o),n(o,a)||e().onChange?.(o,a)},invoke(t,n){e().onChange?.(t,n)},hash(t){return e().hash?.(t)??String(t)}}}S.cleanup=e=>{},S.ref=e=>{let t=e;return{get:()=>t,set:e=>{t=e}}};function C(e){let t={current:e};return{get(e){return t.current[e]},set(e,n){t.current[e]=n}}}var w=class{scope;ctx;prop;state;refs;computed;event={type:``};previousEvent;effects=new Map;transition=null;cleanups=[];subscriptions=[];getEvent=()=>({...this.event,current:()=>this.event,previous:()=>this.previousEvent});getState=()=>({...this.state,matches:(...e)=>e.includes(this.state.get()),hasTag:e=>!!this.machine.states[this.state.get()]?.tags?.includes(e)});debug=(...e)=>{this.machine.debug&&console.log(...e)};notify=()=>{this.publish()};constructor(t,r={}){this.machine=t;let{id:i,ids:a,getRootNode:c}=f(r);this.scope=n({id:i,ids:a,getRootNode:c});let l=e=>{let n=f(r),i=t.props?.({props:s(n),scope:this.scope})??n;return i[e]};this.prop=l;let u=t.context?.({prop:l,bindable:S,scope:this.scope,flush(e){queueMicrotask(e)},getContext(){return d},getComputed(){return p},getRefs(){return m},getEvent:this.getEvent.bind(this)});u&&Object.values(u).forEach(e=>{let t=o(e.ref,()=>this.notify());this.cleanups.push(t)});let d={get(e){return u?.[e].get()},set(e,t){u?.[e].set(t)},initial(e){return u?.[e].initial},hash(e){let t=u?.[e].get();return u?.[e].hash(t)}};this.ctx=d;let p=e=>t.computed?.[e]({context:d,event:this.getEvent(),prop:l,refs:this.refs,scope:this.scope,computed:p})??{};this.computed=p;let m=C(t.refs?.({prop:l,context:d})??{});this.refs=m;let h=S(()=>({defaultValue:t.initialState({prop:l}),onChange:(n,r)=>{if(r){let e=this.effects.get(r);e?.(),this.effects.delete(r)}r&&this.action(t.states[r]?.exit),this.action(this.transition?.actions);let i=this.effect(t.states[n]?.effects);if(i&&this.effects.set(n,i),r===e){this.action(t.entry);let n=this.effect(t.effects);n&&this.effects.set(e,n)}this.action(t.states[n]?.entry)}}));this.state=h,this.cleanups.push(o(this.state.ref,()=>this.notify()))}send=e=>{this.status===t.Started&&queueMicrotask(()=>{this.previousEvent=this.event,this.event=e,this.debug(`send`,e);let t=this.state.get(),n=this.machine.states[t].on?.[e.type]??this.machine.on?.[e.type],r=this.choose(n);if(!r)return;this.transition=r;let i=r.target??t;this.debug(`transition`,r);let a=i!==t;a?this.state.set(i):this.action(r.actions)})};action=e=>{let t=u(e)?e(this.getParams()):e;if(!t)return;let n=t.map(e=>{let t=this.machine.implementations?.actions?.[e];return t||m(`[zag-js] No implementation found for action "${JSON.stringify(e)}"`),t});for(let e of n)e?.(this.getParams())};guard=e=>u(e)?e(this.getParams()):this.machine.implementations?.guards?.[e](this.getParams());effect=e=>{let t=u(e)?e(this.getParams()):e;if(!t)return;let n=t.map(e=>{let t=this.machine.implementations?.effects?.[e];return t||m(`[zag-js] No implementation found for effect "${JSON.stringify(e)}"`),t}),r=[];for(let e of n){let t=e?.(this.getParams());t&&r.push(t)}return()=>r.forEach(e=>e?.())};choose=e=>p(e).find(e=>{let t=!e.guard;return d(e.guard)?t=!!this.guard(e.guard):u(e.guard)&&(t=e.guard(this.getParams())),t});start(){this.status=t.Started,this.debug(`initializing...`),this.state.invoke(this.state.initial,e),this.setupTrackers()}stop(){this.effects.forEach(e=>e?.()),this.effects.clear(),this.transition=null,this.action(this.machine.exit),this.cleanups.forEach(e=>e()),this.cleanups=[],this.status=t.Stopped,this.debug(`unmounting...`)}subscribe=e=>{this.subscriptions.push(e)};status=t.NotStarted;get service(){return{state:this.getState(),send:this.send,context:this.ctx,prop:this.prop,scope:this.scope,refs:this.refs,computed:this.computed,event:this.getEvent(),getStatus:()=>this.status}}publish=()=>{this.callTrackers(),this.subscriptions.forEach(e=>e(this.service))};trackers=[];setupTrackers=()=>{this.machine.watch?.(this.getParams())};callTrackers=()=>{this.trackers.forEach(({deps:e,fn:t})=>{let n=e.map(e=>e());l(t.prev,n)||(t(),t.prev=n)})};getParams=()=>({state:this.getState(),context:this.ctx,event:this.getEvent(),prop:this.prop,send:this.send,action:this.action,guard:this.guard,track:(e,t)=>{t.prev=e.map(e=>e()),this.trackers.push({deps:e,fn:t})},refs:this.refs,computed:this.computed,flush:c,scope:this.scope,choose:this.choose})};const T={onFocus:`onFocusin`,onBlur:`onFocusout`,onChange:`onInput`,onDoubleClick:`onDblclick`,htmlFor:`for`,className:`class`,defaultValue:`value`,defaultChecked:`checked`},E=e=>{let t=``;for(let n in e){let r=e[n];if(r==null)continue;n.startsWith(`--`)||(n=n.replace(/[A-Z]/g,e=>`-${e.toLowerCase()}`)),t+=`${n}:${r};`}return t},D=h(e=>Object.entries(e).reduce((e,[t,n])=>n===void 0?e:(t in T&&(t=T[t]),t===`style`&&typeof n==`object`?(e.style=E(n),e):(e[t.toLowerCase()]=n,e)),{})),O=new Map;function k(e,t,n){e.__spreadId||=`spread_${g()}`;let r=``;r=n?`${e.__spreadId}_${n}`:`${e.__spreadId}`;let i=O.get(r)||{},a=Object.keys(t),o=(t,n)=>{e.addEventListener(t.toLowerCase(),n)},s=(t,n)=>{e.removeEventListener(t.toLowerCase(),n)},c=e=>e.startsWith(`on`),l=e=>!e.startsWith(`on`),u=e=>o(e.substring(2),t[e]),d=e=>s(e.substring(2),t[e]),f=n=>{let r=t[n],a=i[n];if(r!==a){if(n===`children`){e.textContent=r;return}if(typeof r==`boolean`&&(n.includes(`aria-`)||(r||=void 0)),r!=null){[`value`,`checked`,`htmlFor`].includes(n)?e[n]=r:e.setAttribute(n.toLowerCase(),r);return}e.removeAttribute(n.toLowerCase())}};for(let n in i)t[n]??e.removeAttribute(n.toLowerCase());let p=Object.keys(i).filter(c);return p.forEach(e=>{s(e.substring(2),i[e])}),a.filter(c).forEach(u),a.filter(l).forEach(f),O.set(r,t),function(){a.filter(c).forEach(d)}}export{_ as Component,b as ComponentHydrator,w as Machine,v as getHydrationData,x as getListCollectionFromHydrationData,y as initAllComponentInstances,r as mergeProps,D as normalizeProps,k as spreadProps};