import{Component as e,Machine as t,normalizeProps as n,registerFieldMachine as r}from"./Client-oBmSvCIl.js";import{getControlId as i,getErrorId as a,getLabelId as o,getRootEl as s,getRootId as c}from"./field.dom-BPeGctuk.js";import{getFormMachineFor as l,registerFieldMachineForForm as u}from"./form.registry-ABqE-vzj.js";import{createMachine as d}from"@zag-js/core";import{createAnatomy as f}from"@zag-js/anatomy";const p=f(`field`).parts(`root`,`label`,`control`,`error`),m=p.build();function h(e,t){let{scope:n,prop:r,context:s,computed:l}=e,u=s.get(`invalid`),d=l(`errors`);return{getFormMachine:()=>s.get(`formMachine`),invalid:u,errors:d,name:r(`name`),getErrorText(){return d.length?d[0]:null},getRootProps(){return t.element({...m.root.attrs,id:c(n),"data-invalid":u?``:void 0,"data-name":r(`name`)})},getLabelProps(){return t.label({...m.label.attrs,id:o(n),htmlFor:i(n)})},getControlProps(){return t.element({...m.control.attrs,id:i(n),name:r(`name`),"aria-invalid":u?`true`:`false`,"aria-describedby":s.get(`describeIds`),"data-invalid":u?``:void 0})},getErrorProps(){return t.element({...m.error.attrs,id:a(n),hidden:!u})}}}const g=d({initialState(){return`ready`},context({bindable:e,prop:t}){return{invalid:e(()=>({defaultValue:t(`invalid`)??!1})),required:e(()=>({defaultValue:t(`required`)??!1})),disabled:e(()=>({defaultValue:t(`disabled`)??!1})),readOnly:e(()=>({defaultValue:t(`readOnly`)??!1})),formMachine:e(()=>({defaultValue:null,hash:e=>JSON.stringify({state:e?.state,errors:e?.ctx.get(`errors`)})})),describeIds:e(()=>({defaultValue:void 0}))}},entry:[`getFormMachine`,`determineDescribeIds`,`updateInvalid`],states:{ready:{}},computed:{errors({context:e,prop:t}){let n=e.get(`formMachine`)?.ctx;if(!n)return[];let r=n.get(`errors`)?.[t(`name`)]??[];return r}},watch({track:e,context:t,computed:n,action:r}){e([()=>t.hash(`formMachine`),()=>n(`errors`).join(`|`)],()=>{r([`updateInvalid`])}),e([()=>t.get(`invalid`)],()=>{r([`determineDescribeIds`])})},implementations:{actions:{getFormMachine({context:e,scope:t}){if(e.get(`formMachine`))return;let n=s(t);if(!n)return;let r=l(n)??null;if(r)e.set(`formMachine`,r);else{let t=n.closest(`form`);if(!t)return;let r=()=>{let i=l(n)??null;e.set(`formMachine`,i),t.removeEventListener(`fluid-primitives:form:registered`,r)};t.addEventListener(`fluid-primitives:form:registered`,r)}},determineDescribeIds({context:e,scope:t}){let n=[];e.get(`invalid`)&&n.push(a(t));let r=n.join(` `)||void 0;e.set(`describeIds`,r)},updateInvalid({context:e,prop:t}){let n=e.get(`formMachine`)?.ctx;if(!n){e.set(`invalid`,t(`invalid`)??!1);return}let r=n.get(`errors`)?.[t(`name`)]??[];e.set(`invalid`,r.length>0)}}}});var _=class extends e{static name=`field`;subscribedToForm=!1;initMachine(e){let n=new t(g,e);return r(this.getElement(`root`),n),u(this.getElement(`root`),n),n}initApi(){return h(this.machine.service,n)}subscribeToFormMachine(){if(this.subscribedToForm)return;let e=this.api.getFormMachine();e&&(this.subscribedToForm=!0,e.subscribe(()=>{this.machine.notify()}))}render(){this.subscribeToFormMachine();let e=this.getElement(`root`);e&&this.spreadProps(e,this.api.getRootProps());let t=this.getElement(`label`);t&&this.spreadProps(t,this.api.getLabelProps());let n=this.getElement(`control`);n&&this.spreadProps(n,this.api.getControlProps());let r=this.getElement(`error`);if(r){this.spreadProps(r,this.api.getErrorProps());let e=this.api.getErrorText();r.textContent!==void 0&&(r.textContent=e??``)}}};export{_ as Field};