import{Component as e,Machine as t,normalizeProps as n,registerFieldMachine as r}from"./Client-B_z96Vju.js";import{getControlId as i,getErrorId as a,getLabelId as o,getRootEl as s,getRootId as c}from"./field.dom-BPeGctuk.js";import{getFormMachineFor as l}from"./form.registry-BEubiwYA.js";import{createMachine as u}from"@zag-js/core";import{createAnatomy as d}from"@zag-js/anatomy";const f=d(`field`).parts(`root`,`label`,`control`,`error`),p=f.build();function m(e,t){let{scope:n,prop:r,context:s,computed:l}=e,u=s.get(`invalid`),d=l(`errors`);return{getFormMachine:()=>s.get(`formMachine`),invalid:u,errors:d,name:r(`name`),getErrorText(){return d.length?d[0]:null},getRootProps(){return t.element({...p.root.attrs,id:c(n),"data-invalid":u?``:void 0})},getLabelProps(){return t.label({...p.label.attrs,id:o(n),htmlFor:i(n)})},getControlProps(){return t.element({...p.control.attrs,id:i(n),name:r(`name`),"aria-invalid":u?`true`:`false`,"aria-describedby":s.get(`describeIds`),"data-invalid":u?``:void 0})},getErrorProps(){return t.element({...p.error.attrs,id:a(n),hidden:!u})}}}const h=u({initialState(){return`ready`},context({bindable:e,prop:t}){return{invalid:e(()=>({defaultValue:t(`invalid`)??!1})),required:e(()=>({defaultValue:t(`required`)??!1})),disabled:e(()=>({defaultValue:t(`disabled`)??!1})),readOnly:e(()=>({defaultValue:t(`readOnly`)??!1})),formMachine:e(()=>({defaultValue:null})),describeIds:e(()=>({defaultValue:void 0}))}},entry:[`getFormMachine`,`determineDescribeIds`],states:{ready:{}},computed:{errors({context:e,prop:t}){let n=e.get(`formMachine`)?.ctx;if(!n)return[];let r=n.get(`errors`)?.[t(`name`)]??[];return r}},watch({track:e,context:t,computed:n,prop:r,action:i}){e([()=>n(`errors`).join(`|`)],()=>{i([`updateInvalid`])}),e([()=>t.get(`invalid`)],()=>{i([`determineDescribeIds`])})},implementations:{actions:{getFormMachine({context:e,scope:t}){if(e.get(`formMachine`))return;let n=s(t);if(!n)return;let r=l(n)??null;if(r)e.set(`formMachine`,r);else{let t=()=>{let r=l(n)??null;e.set(`formMachine`,r),n.removeEventListener(`fluid-primitives:form:ready`,t)};n.addEventListener(`fluid-primitives:form:ready`,t)}},determineDescribeIds({context:e,scope:t,computed:n}){let r=[];e.get(`invalid`)&&r.push(a(t));let i=r.join(` `)||void 0;e.set(`describeIds`,i)},updateInvalid({context:e,prop:t}){let n=e.get(`formMachine`)?.ctx;if(!n){e.set(`invalid`,!1);return}let r=n.get(`errors`)?.[t(`name`)]??[];e.set(`invalid`,r.length>0)}}}});var g=class extends e{static name=`field`;subscribedToForm=!1;initMachine(e){let n=new t(h,e);return r(this.getElement(`root`),n),n}initApi(){return m(this.machine.service,n)}subscribeToFormMachine(){if(this.subscribedToForm)return;let e=this.api.getFormMachine();e&&(this.subscribedToForm=!0,e.subscribe(()=>{console.log(`form subscribe calls render`,this.api.name,e.ctx.get(`errors`)),queueMicrotask(()=>{this.api=this.initApi(),this.render()})}))}render(){this.subscribeToFormMachine();let e=this.getElement(`root`);e&&this.spreadProps(e,this.api.getRootProps()),console.log(`render field`,this.api.name,{invalid:this.api.invalid,errors:this.api.errors});let t=this.getElement(`label`);t&&this.spreadProps(t,this.api.getLabelProps());let n=this.getElement(`control`);n&&this.spreadProps(n,this.api.getControlProps());let r=this.getElement(`error`);if(r){this.spreadProps(r,this.api.getErrorProps());let e=this.api.getErrorText();r.textContent!==void 0&&(r.textContent=e??``)}}};export{g as Field};