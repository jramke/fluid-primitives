import{Component as e,Machine as t,normalizeProps as n}from"./Client-oBmSvCIl.js";import{getFieldMachinesFor as r,registerFormMachine as i}from"./form.registry-ABqE-vzj.js";import{createMachine as a}from"@zag-js/core";import{createAnatomy as o}from"@zag-js/anatomy";import{dataAttr as s}from"@zag-js/dom-query";const c=o(`form`).parts(`form`),l=c.build(),u=e=>e.ids?.form??`form:${e.id}:form`,d=e=>e.getById(u(e));function f(e,t){let{context:n,state:i,send:a,scope:o,prop:c}=e;function f(){return n.get(`values`)}function p(){return n.get(`errors`)}function m(){return n.get(`dirty`)}function h(){return d(o)}let g=i.matches(`submitting`),_=Object.values(m()).some(e=>e),v=Object.values(p()).some(e=>e),y=i.matches(`success`),b=i.matches(`error`),x=i.get();return{isSubmitting:g,isDirty:_,isInvalid:v,isSuccessful:y,isError:b,getValues:f,getErrors:p,getDirty:m,userRenderFn:c(`render`),getFormEl:h,getFields(){return r(d(o))},getAction(){let e=h();return e.getAttribute(`action`)||``},getFormProps(){return t.element({...l.form.attrs,noValidate:s(!0),id:u(o),"data-state":x,onSubmit:async e=>{e.preventDefault();let t=e.currentTarget;n.set(`values`,new FormData(t)),a({type:`SUBMIT`,detail:{event:e,api:this}})},onReset:e=>{let t=e.currentTarget;queueMicrotask(()=>{let e=new FormData(t);n.set(`initialValues`,e),n.set(`values`,e),n.set(`errors`,{});let r={};for(let t of Object.keys(e))r[t]=!1;n.set(`dirty`,r)}),a({type:`RESET`})},onInput:e=>{a({type:`INPUT`,detail:{target:e.target}})},onChange_:e=>{a({type:`INPUT`,detail:{target:e.target}})}})}}}let p;function m(e){return{lang:e?.lang??p?.lang,message:e?.message,abortEarly:e?.abortEarly??p?.abortEarly,abortPipeEarly:e?.abortPipeEarly??p?.abortPipeEarly}}function h(e,t,n){let r=e[`~run`]({value:t},m(n));return{typed:r.typed,success:!r.issues,output:r.value,issues:r.issues}}function g(e){if(!e||e.length===0)return``;let t=e.map(e=>typeof e.key==`number`?String(e.key):typeof e.key==`string`?e.key:typeof e.index==`number`?String(e.index):``).filter(Boolean);return t.join(`.`)}function _(e,t){if(e.success)return{};let n={};for(let r of e.issues){let e=t||g(r.path)||(typeof r.input==`string`?r.input:``),i=r.message??`Invalid value`;n[e]||(n[e]=[]),n[e].push(i)}return n}function v(e,t){let n={};for(let r in e){let i=r;t&&(i=i.replace(t+`.`,``)),n[i]=e[r]}return n}function y(e){let t=e;if(!(!t||!(`type`in t))){if(t.type===`checkbox`){let e=t;if(e.name){let t=e.form;if(t){let n=Array.from(t.querySelectorAll(`input[type="checkbox"][name="${CSS.escape(e.name)}"]`)),r=n.filter(e=>e.checked).map(e=>e.value||`on`);return n.length===1&&!n[0].value?n[0].checked:r}}return e.checked}if(t.type===`radio`){let e=t;if(e.form&&e.name){let t=e.form.querySelector(`input[type="radio"][name="${CSS.escape(e.name)}"]:checked`);return t?t.value:``}return e.checked?e.value:``}return t instanceof HTMLSelectElement&&t.multiple?Array.from(t.selectedOptions).map(e=>e.value):t.value}}function b(e,t,n){if(e===``)return``;n&&(e=`${n}[${e}]`);let r=e.split(`[`,2),i=`${t}[${r[0]}]`;return r.length>1&&(i+=`[${r[1]}`),i}const x=a({initialState(){return`ready`},context({bindable:e}){return{values:e(()=>({defaultValue:new FormData})),initialValues:e(()=>({defaultValue:new FormData})),errors:e(()=>({defaultValue:{}})),dirty:e(()=>({defaultValue:{}}))}},states:{ready:{},invalid:{},submitting:{},success:{},error:{}},on:{SUBMIT:{target:`submitting`,actions:[`validateAll`]},VALIDATE:{actions:[`validateAll`]},INVALID:{target:`invalid`},INPUT:{actions:[`handleInput`]},RESET:{target:`ready`,actions:[`resetForm`]},ERROR:{target:`error`},SUCCESS:{target:`success`}},entry:[`handleFieldBlurs`],implementations:{actions:{validateAll({context:e,send:t,prop:n,state:r,action:i,event:a,scope:o}){let s=r.matches(`submitting`),c=n(`schema`);if(c){let n=h(c,Object.fromEntries(e.get(`values`).entries())),r=_(n);if(e.set(`errors`,r),Object.keys(r).length>0){t({type:`INVALID`}),s&&i([`focusFirstInvalid`]);return}}if(!s){r.set(`ready`);return}let l=n(`onSubmit`);if(!l){t({type:`SUCCESS`});return}let u;try{u=l({formData:e.get(`values`),api:a.detail.api,event:a.detail.event,post:async(r,i)=>{let a=new FormData,s=n(`objectName`),c=d(o).getAttribute(`data-field-name-prefix`)||``;for(let[e,t]of i.entries()){if(e.includes(c)){a.append(e,t);continue}a.append(b(e,c,s),t)}let l=await fetch(r,{method:`POST`,body:a});if(l.status===422){let n=await l.json();e.set(`errors`,v(n,s)),t({type:`INVALID`})}return l}})}catch{t({type:`ERROR`});return}u instanceof Promise?u.then(e=>{t(e?{type:`SUCCESS`}:{type:`ERROR`})}).catch(()=>{t({type:`ERROR`})}):t(u?{type:`SUCCESS`}:{type:`ERROR`})},handleInput({context:e,event:t,action:n,prop:r}){let i=t,a=i?.detail?.target??i?.target??i?.currentTarget,o=a?.name;if(!o)return;let s=r(`reactiveFields`)||[];if(s.length===0||!s.includes(o))return;let c=i?.detail?.value??y(a),l=e.get(`values`);l.set(o,c),e.set(`values`,l);let u=e.get(`initialValues`).get(o),d={...e.get(`dirty`)};d[o]=JSON.stringify(l.get(o))!==JSON.stringify(u),e.set(`dirty`,d),e.get(`errors`)[o]&&n([`validateAll`])},resetForm({context:e}){let t=e.get(`initialValues`);e.set(`values`,{...t}),e.set(`errors`,{});let n={};for(let e of Object.keys(t))n[e]=!1;e.set(`dirty`,n)},focusFirstInvalid({context:e,scope:t}){let n=e.get(`errors`),r=Object.keys(n)[0];if(!r)return;let i=d(t),a=i.querySelector(`[name="${CSS.escape(r)}"]`);a?.focus()},handleFieldBlurs({scope:e}){let t=d(e);if(!t)return;let n=e=>{let t=e.target,n=t?.name};t.addEventListener(`blur`,n,!0)}}}});var S=class extends e{static name=`form`;initMachine(e){let n=new t(x,e);return i(this.getElement(`form`),n),n}initApi(){return f(this.machine.service,n)}render(){let e=this.getElement(`form`);e&&(this.spreadProps(e,this.api.getFormProps()),this.api.userRenderFn?.(this))}};export{S as Form};