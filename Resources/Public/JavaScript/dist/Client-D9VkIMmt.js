import{ListCollection as e}from"@zag-js/collection";import{INIT_STATE as t,MachineStatus as n,createScope as r,mergeProps as i}from"@zag-js/core";import{proxy as a,subscribe as o}from"@zag-js/store";import{compact as s,identity as c,isEqual as l,isFunction as u,isString as d,runIfFn as f,toArray as p,warn as m}from"@zag-js/utils";import{createNormalizer as h}from"@zag-js/types";import{nanoid as g}from"nanoid";var _=class{document;machine;api;hydrator=null;userProps;static name;get doc(){return this.document}constructor(e,t=document){this.document=t,this.userProps=this.transformProps(e),this.hydrator=this.initHydrator(e),this.machine=this.initMachine(e),this.api=this.initApi()}initHydrator(e){let t=e.id;if(!t)throw Error(`ComponentHydrator requires an id prop to initialize.`);return new E(this.getName(),t,e.ids,this.doc)}init(){this.render(),this.machine.subscribe(()=>{this.api=this.initApi(),this.render()}),this.machine.start()}getName(){return this.constructor.name}transformProps(e){return e}updateProps(e){let t={...this.userProps,...e};this.userProps=this.transformProps(t),this.machine.updateProps(t)}destroy=()=>{this.machine.stop(),this.hydrator?.destroy()};spreadProps(e,t){V(e,t,this.machine.scope.id)}getElement(e,t){return this.hydrator?.getElement(e,t)||null}getElements(e,t){return this.hydrator?.getElements(e,t)||[]}portalElement(e,t=this.doc.body){e&&e.parentNode!==t&&(t.appendChild(e),e.setAttribute(`data-portalled`,`true`))}};const v=new WeakMap;function y(e,t){e&&(v.set(e,t),e.dispatchEvent(new CustomEvent(`fluid-primitives:field:registered`,{bubbles:!0})))}function b(e){if(e)return v.get(e)}const x=[`invalid`,`disabled`,`readOnly`,`required`],S={disabled:e=>e.context.get(`disabled`),readOnly:e=>e.context.get(`readOnly`),required:e=>e.context.get(`required`),invalid:e=>e.context.get(`invalid`)};var C=class extends _{subscribedToField=!1;fieldMachine;closestField=null;getClosestField(){return this.closestField||this.getElement(`root`)?.closest(`[data-scope="field"][data-part="root"]`)||null}withFieldProps(e){if(this.closestField=this.getClosestField(),!this.closestField)return e;if(this.fieldMachine=b(this.closestField),this.fieldMachine)return this.propsWithField(e,this.fieldMachine);{let e=()=>{this.fieldMachine=b(this.closestField),this.updateProps(this.propsWithField(this.userProps,this.fieldMachine)),this.closestField?.removeEventListener(`fluid-primitives:field:registered`,e)};this.closestField.addEventListener(`fluid-primitives:field:registered`,e)}return e}subscribeToFieldService(){if(!this.subscribedToField&&(this.closestField=this.getClosestField(),this.closestField))if(this.fieldMachine)this.fieldMachine.subscribe(e=>{queueMicrotask(()=>{let t={};for(let n of x){let r=!!S[n](e),i=!!this.machine.prop(n);r!==i&&(t[n]=r)}Object.keys(t).length>0?this.updateProps(t):(this.api=this.initApi(),this.render())})}),this.subscribedToField=!0;else{let e=()=>{this.subscribeToFieldService(),this.closestField.removeEventListener(`fluid-primitives:field:registered`,e)};this.closestField.addEventListener(`fluid-primitives:field:registered`,e)}}};function w(e,t){let n=window.FluidPrimitives.hydrationData;return!n||typeof n!=`object`?null:e?n[e]?t?n[e][t]||null:n[e]:null:n}function T(e,t){let n=w(e);n&&Object.keys(n).forEach(r=>{if(n[r].controlled)return;let i=t(n[r]);i&&(window.FluidPrimitives.uncontrolledInstances[e]||(window.FluidPrimitives.uncontrolledInstances[e]={}),window.FluidPrimitives.uncontrolledInstances[e][r]=i)})}var E=class{componentName;doc;rootId;ids;elementRefs=new Map;constructor(e,t,n={},r=document){if(this.componentName=e,this.doc=r,!t)throw Error(`Root ID is required for component hydration: ${e}`);this.rootId=t,this.ids=n}getElement(e,t=this.doc){if(this.elementRefs.has(e))return this.elementRefs.get(e)||null;let n=null;return n=this.ids[e]?t.querySelector(`#${this.ids[e]}`):t.querySelector(`[data-hydrate-${this.componentName}="${this.rootId}"][data-part="${e}"][data-scope="${this.componentName}"]`),n&&(t===this.doc&&this.elementRefs.set(e,n),n.removeAttribute(`data-hydrate-${this.componentName}`),n.__rootId=this.rootId),n}getElements(e,t=this.doc){if(this.elementRefs.has(e))return this.elementRefs.get(e);let n=[];return n=this.ids[e]?Array.from(t.querySelectorAll(`#${this.ids[e]}`)):Array.from(t.querySelectorAll(`[data-hydrate-${this.componentName}="${this.rootId}"][data-part="${e}"][data-scope="${this.componentName}"]`)),t===this.doc&&this.elementRefs.set(e,n),n.forEach(e=>e.removeAttribute(`data-hydrate-${this.componentName}`)),n}generateRefAttributesString(e){let t=this.ids[e]||`${this.rootId}-${e}`;return`data-scope="${this.componentName}" data-part="${e}" data-hydrate-${this.componentName}="${t}"`}setRefAttributes(e,t){let n=this.generateRefAttributesString(t),r=n.split(` `).map(e=>e.trim());r.forEach(t=>{let[n,r]=t.split(`=`);e.setAttribute(n,r.replace(/"/g,``))})}destroy(){this.elementRefs.forEach(e=>{e instanceof Element?e.setAttribute(`data-hydrate-${this.componentName}`,this.rootId):e.forEach(e=>e.setAttribute(`data-hydrate-${this.componentName}`,this.rootId))}),this.elementRefs.clear()}};function D(t){if(t instanceof e)return t;let n=new e({items:t.items,itemToValue:t.itemToValueKey?e=>e?.[t.itemToValueKey]:void 0,itemToString:t.itemToStringKey?e=>e?.[t.itemToStringKey]:void 0,isItemDisabled:t.isItemDisabledKey?e=>e?.[t.isItemDisabledKey]:void 0,groupBy:t.groupByKey?e=>{let n=t.groupByKey;if(n)return n.includes(`.`)?n.split(`.`).reduce((e,t)=>e?e[t]:void 0,e):e?.[n]}:void 0});return n}function O(e){let t=e().value??e().defaultValue;e().debug&&console.log(`[bindable > ${e().debug}] initial`,t);let n=e().isEqual??Object.is,r=a({value:t}),i=()=>e().value!==void 0;return{initial:t,ref:r,get(){return i()?e().value:r.value},set(t){let a=r.value,o=u(t)?t(a):t;e().debug&&console.log(`[bindable > ${e().debug}] setValue`,{next:o,prev:a}),i()||(r.value=o),n(o,a)||e().onChange?.(o,a)},invoke(t,n){e().onChange?.(t,n)},hash(t){return e().hash?.(t)??String(t)}}}O.cleanup=e=>{},O.ref=e=>{let t=e;return{get:()=>t,set:e=>{t=e}}};function k(e){let t={current:e};return{get(e){return t.current[e]},set(e,n){t.current[e]=n}}}var A=class{scope;ctx;prop;state;refs;computed;event={type:``};previousEvent;effects=new Map;transition=null;cleanups=[];subscriptions=[];userPropsRef;getEvent=()=>({...this.event,current:()=>this.event,previous:()=>this.previousEvent});getState=()=>({...this.state,matches:(...e)=>e.includes(this.state.get()),hasTag:e=>!!this.machine.states[this.state.get()]?.tags?.includes(e)});debug=(...e)=>{this.machine.debug&&console.log(...e)};notify=()=>{this.publish()};constructor(e,n={}){this.machine=e,this.userPropsRef={current:n};let{id:i,ids:a,getRootNode:c}=f(n);this.scope=r({id:i,ids:a,getRootNode:c});let l=t=>{let n=f(this.userPropsRef.current),r=e.props?.({props:s(n),scope:this.scope})??n;return r[t]};this.prop=l;let u=e.context?.({prop:l,bindable:O,scope:this.scope,flush(e){queueMicrotask(e)},getContext(){return d},getComputed(){return p},getRefs(){return m},getEvent:this.getEvent.bind(this)});u&&Object.values(u).forEach(e=>{let t=o(e.ref,()=>this.notify());this.cleanups.push(t)});let d={get(e){return u?.[e].get()},set(e,t){u?.[e].set(t)},initial(e){return u?.[e].initial},hash(e){let t=u?.[e].get();return u?.[e].hash(t)}};this.ctx=d;let p=t=>e.computed?.[t]({context:d,event:this.getEvent(),prop:l,refs:this.refs,scope:this.scope,computed:p})??{};this.computed=p;let m=k(e.refs?.({prop:l,context:d})??{});this.refs=m;let h=O(()=>({defaultValue:e.initialState({prop:l}),onChange:(n,r)=>{if(r){let e=this.effects.get(r);e?.(),this.effects.delete(r)}r&&this.action(e.states[r]?.exit),this.action(this.transition?.actions);let i=this.effect(e.states[n]?.effects);if(i&&this.effects.set(n,i),r===t){this.action(e.entry);let n=this.effect(e.effects);n&&this.effects.set(t,n)}this.action(e.states[n]?.entry)}}));this.state=h,this.cleanups.push(o(this.state.ref,()=>this.notify()))}updateProps(e){this.userPropsRef.current=e,this.notify()}send=e=>{this.status===n.Started&&queueMicrotask(()=>{this.previousEvent=this.event,this.event=e,this.debug(`send`,e);let t=this.state.get(),n=this.machine.states[t].on?.[e.type]??this.machine.on?.[e.type],r=this.choose(n);if(!r)return;this.transition=r;let i=r.target??t;this.debug(`transition`,r);let a=i!==t;a?this.state.set(i):this.action(r.actions)})};action=e=>{let t=u(e)?e(this.getParams()):e;if(!t)return;let n=t.map(e=>{let t=this.machine.implementations?.actions?.[e];return t||m(`[zag-js] No implementation found for action "${JSON.stringify(e)}"`),t});for(let e of n)e?.(this.getParams())};guard=e=>u(e)?e(this.getParams()):this.machine.implementations?.guards?.[e](this.getParams());effect=e=>{let t=u(e)?e(this.getParams()):e;if(!t)return;let n=t.map(e=>{let t=this.machine.implementations?.effects?.[e];return t||m(`[zag-js] No implementation found for effect "${JSON.stringify(e)}"`),t}),r=[];for(let e of n){let t=e?.(this.getParams());t&&r.push(t)}return()=>r.forEach(e=>e?.())};choose=e=>p(e).find(e=>{let t=!e.guard;return d(e.guard)?t=!!this.guard(e.guard):u(e.guard)&&(t=e.guard(this.getParams())),t});start(){this.status=n.Started,this.debug(`initializing...`),this.state.invoke(this.state.initial,t),this.setupTrackers()}stop(){this.effects.forEach(e=>e?.()),this.effects.clear(),this.transition=null,this.action(this.machine.exit),this.cleanups.forEach(e=>e()),this.cleanups=[],this.status=n.Stopped,this.debug(`unmounting...`)}subscribe=e=>{this.subscriptions.push(e)};status=n.NotStarted;get service(){return{state:this.getState(),send:this.send,context:this.ctx,prop:this.prop,scope:this.scope,refs:this.refs,computed:this.computed,event:this.getEvent(),getStatus:()=>this.status}}publish=()=>{this.callTrackers(),this.subscriptions.forEach(e=>e(this.service))};trackers=[];setupTrackers=()=>{this.machine.watch?.(this.getParams())};callTrackers=()=>{this.trackers.forEach(({deps:e,fn:t})=>{let n=e.map(e=>e());l(t.prev,n)||(t(),t.prev=n)})};getParams=()=>({state:this.getState(),context:this.ctx,event:this.getEvent(),prop:this.prop,send:this.send,action:this.action,guard:this.guard,track:(e,t)=>{t.prev=e.map(e=>e()),this.trackers.push({deps:e,fn:t})},refs:this.refs,computed:this.computed,flush:c,scope:this.scope,choose:this.choose})};const j={onFocus:`onFocusin`,onBlur:`onFocusout`,onChange:`onInput`,onDoubleClick:`onDblclick`,htmlFor:`for`,className:`class`,defaultValue:`value`,defaultChecked:`checked`,onChange_:`onChange`},M=new Set([`viewBox`,`preserveAspectRatio`]),N=e=>{let t=``;for(let n in e){let r=e[n];if(r==null)continue;n.startsWith(`--`)||(n=n.replace(/[A-Z]/g,e=>`-${e.toLowerCase()}`)),t+=`${n}:${r};`}return t},P=h(e=>Object.entries(e).reduce((e,[t,n])=>{if(n===void 0)return e;if(t in j&&(t=j[t]),t===`style`&&typeof n==`object`)return e.style=N(n),e;let r=M.has(t)?t:t.toLowerCase();return e[r]=n,e},{}));function F(...e){let t=i(...e);return`style`in t&&(t.style=N(t.style)),t}const I=new Map,L=new Set([`value`,`checked`,`htmlFor`]),R=new Set([`viewBox`,`preserveAspectRatio`]),z=e=>e.tagName===`svg`||e.namespaceURI===`http://www.w3.org/2000/svg`,B=(e,t)=>{let n=z(e)&&R.has(t);return n?t:t.toLowerCase()};function V(e,t,n){e.__spreadId||=`spread_${g()}`;let r=``;r=n?`${e.__spreadId}_${n}`:`${e.__spreadId}`;let i=I.get(r)||{},a=Object.keys(t),o=(t,n)=>{e.addEventListener(t.toLowerCase(),n)},s=(t,n)=>{e.removeEventListener(t.toLowerCase(),n)},c=e=>e.startsWith(`on`),l=e=>!e.startsWith(`on`),u=e=>o(e.substring(2),t[e]),d=e=>s(e.substring(2),t[e]),f=n=>{let r=t[n],a=i[n];if(r!==a){if(n===`children`){e.textContent=r;return}if(typeof r==`boolean`&&(n.includes(`aria-`)||(r||=void 0)),r!=null){L.has(n)?e[n]=r:e.setAttribute(B(e,n),r);return}e.removeAttribute(B(e,n))}};for(let n in i)t[n]??e.removeAttribute(B(e,n));let p=Object.keys(i).filter(c);return p.forEach(e=>{s(e.substring(2),i[e])}),a.filter(c).forEach(u),a.filter(l).forEach(f),I.set(r,t),function(){a.filter(c).forEach(d)}}export{_ as Component,E as ComponentHydrator,C as FieldAwareComponent,A as Machine,w as getHydrationData,D as getListCollectionFromHydrationData,T as initAllComponentInstances,F as mergeProps,P as normalizeProps,y as registerFieldMachine,V as spreadProps};