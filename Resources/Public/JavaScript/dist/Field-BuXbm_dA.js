import{Component as e,Machine as t,normalizeProps as n}from"./Client-D6VJwEI0.js";import{getControlId as r,getErrorId as i,getLabelId as a,getRootEl as o,getRootId as s,registerFieldMachine as c}from"./field.dom-Bv_IpKYL.js";import{getFormMachineFor as l}from"./form.registry-BEubiwYA.js";import{createMachine as u}from"@zag-js/core";import{createAnatomy as d}from"@zag-js/anatomy";const f=d(`field`).parts(`root`,`label`,`control`,`error`),p=f.build();function m(e,t){let{scope:n,prop:o,context:c}=e;function l(){let e=c.get(`formMachine`);if(!e)return{errors:[],invalid:!1};let t=e.ctx.get(`errors`)?.[o(`name`)]??[];return{errors:t,invalid:t.length>0}}let u=l();return{getFormMachine:()=>c.get(`formMachine`),get invalid(){let{invalid:e}=u;return e},get errors(){let{errors:e}=u;return e},name:o(`name`),getErrorText(){let e=this.errors;return e.length?e[0]:null},getRootProps(){return t.element({...p.root.attrs,id:s(n),"data-invalid":this.invalid?``:void 0})},getLabelProps(){return t.label({...p.label.attrs,id:a(n),htmlFor:r(n)})},getControlProps(){let e=this.invalid;return t.element({...p.control.attrs,id:r(n),name:o(`name`),"aria-invalid":e?`true`:`false`,"aria-describedby":c.get(`describeIds`),"data-invalid":e?``:void 0})},getErrorProps(){return t.element({...p.error.attrs,id:i(n),hidden:!this.invalid})}}}const h=u({initialState(){return`ready`},context({bindable:e,prop:t}){return{invalid:e(()=>({defaultValue:t(`invalid`)??!1})),required:e(()=>({defaultValue:t(`required`)??!1})),disabled:e(()=>({defaultValue:t(`disabled`)??!1})),readOnly:e(()=>({defaultValue:t(`readOnly`)??!1})),formMachine:e(()=>({defaultValue:null})),describeIds:e(()=>({defaultValue:void 0}))}},entry:[`getFormMachine`,`determineDescribeIds`],states:{ready:{}},watch({track:e,context:t,prop:n,action:r}){let i=t.get(`formMachine`)?.ctx;e([()=>JSON.stringify(i?.get(`errors`))],()=>{t.set(`invalid`,(i?.get(`errors`)?.[n(`name`)]?.length??0)>0)}),e([()=>t.get(`invalid`)],()=>{r([`determineDescribeIds`])})},implementations:{actions:{getFormMachine({context:e,scope:t}){if(e.get(`formMachine`))return;let n=o(t);if(!n)return;let r=l(n)??null;if(r)e.set(`formMachine`,r);else{let t=()=>{let r=l(n)??null;e.set(`formMachine`,r),n.removeEventListener(`fluid-primitives:form:ready`,t)};n.addEventListener(`fluid-primitives:form:ready`,t)}},determineDescribeIds({context:e,scope:t}){let n=[];e.get(`invalid`)&&n.push(i(t));let r=n.join(` `)||void 0;e.set(`describeIds`,r)}}}});var g=class extends e{static name=`field`;subscribedToForm=!1;initMachine(e){let n=new t(h,e);return c(this.getElement(`root`),n),n}initApi(){return m(this.machine.service,n)}subscribeToFormMachine(){if(this.subscribedToForm)return;let e=this.api.getFormMachine();e&&(this.subscribedToForm=!0,e.subscribe(()=>{this.render()}))}render(){this.subscribeToFormMachine();let e=this.getElement(`root`);e&&this.spreadProps(e,this.api.getRootProps()),console.log(`render field`,this.api.name,{invalid:this.api.invalid,errors:this.api.errors});let t=this.getElement(`label`);t&&this.spreadProps(t,this.api.getLabelProps());let n=this.getElement(`control`);n&&this.spreadProps(n,this.api.getControlProps());let r=this.getElement(`error`);if(r){this.spreadProps(r,this.api.getErrorProps());let e=this.api.getErrorText();r.textContent!==void 0&&(r.textContent=e??``)}}};export{g as Field};